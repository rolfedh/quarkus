////
This document is part of the main Quarkus repository. Submit pull requests here: https://github.com/quarkusio/quarkus/tree/main/docs/src/main/asciidoc
////

[id="security-jpa"]
= Quarkus Security with Jakarta Persistence
include::_attributes.adoc[]
:categories: security
:summary: Learn how to use Jakarta Persistence for user identity storage in Quarkus applications.
:topics: security, identity-providers, sql, database, jpa, jdbc
:extensions: io.quarkus:quarkus-security-jpa-reactive

Quarkus integrates Jakarta Persistence as an identity provider, paralleling the xref:security-jdbc.adoc[JDBC identity provider]. It aligns with Quarkus Security mechanisms like xref:security-basic-authentication.adoc[Basic] and xref:security-authentication-mechanisms.adoc#form-auth[Form-based] authentication, requiring username and password credentials.

Jakarta Persistence's `IdentityProvider` generates a `SecurityIdentity` instance, facilitating user authentication by verifying and authorizing access in Quarkus applications.

For practical implementation, refer to the xref:security-getting-started-tutorial.adoc[Basic authentication and Jakarta Persistence tutorial].

== Jakarta Persistence Entity Specification

Quarkus security leverages Jakarta Persistence for managing usernames, passwords, and roles. These are stored in database entities, retrievable by Quarkus.

Entity specifications for user information storage in Jakarta Persistence are as follows:

* `@UserDefinition` annotation is essential on a Jakarta Persistence entity, irrespective of using xref:hibernate-orm-panache.adoc[Hibernate ORM with Panache].

* `@Username` and `@Password` fields must be of type `String`.

* `@Roles` should be a `String`, `Collection<String>`, or `Collection<X>` (where `X` is an entity class with a `String` field annotated `@RolesValue`).

* Role elements in `String` format should be comma-separated.

Example of security information storage using annotations on a `user` entity:

[source,java]
----
package org.acme.security.jpa;

// [Import statements and User class definition]

    // Method to add a new user
    public static void add(String username, String password, String role) {
        // [User creation and persistence logic]
    }
}

----

Only one entity annotated with `@UserDefinition` initializes the `security-jpa` extension.

* <1> `@UserDefinition` - Identifies the user entity.
* <2> `@Username` - Username field.
* <3> `@Password` - Password field (bcrypt-hashed by default).
* <4> `@Roles` - Comma-separated roles.
* <5> User addition method with password bcrypt hashing.

== Storing Roles in Separate Entities

For role storage in a different entity:

[source,java]
----
@UserDefinition
// [User entity definition with roles stored separately]

@Entity
public class Role extends PanacheEntity {
    // [Role entity definition]
}
----

[NOTE]
====
To modify existing users or create new ones, annotate the `roles` field with `@Cascade(CascadeType.ALL)` or a specific `CascadeType`.
====

== Password Management

Quarkus allows various password management strategies, including default bcrypt hashing or custom methods.

By default, Quarkus uses bcrypt for password hashing, adhering to the Modular Crypt Format (MCF), which includes algorithm, iteration count, and salt in the hashed value.

[NOTE]
====
A "salt" in cryptography refers to random data enhancing hash uniqueness.
====

For representing differently hashed passwords, implement a custom `org.wildfly.security.password.PasswordProvider`.

Example: Custom SHA256 hashed password representation.

[source,java]
----
// [Custom password entity and provider class definitions]
----

[TIP]
====
Use `BcryptUtil.bcryptHash(String password)` for quick bcrypt hash generation.
====

[WARNING]
====
Avoid storing plain text passwords in production. Use `@Password(PasswordType.CLEAR)` for testing only.
====

[TIP]
====
Hibernate Multitenancy is supported. Disable proactive authentication if your `TenantResolver` needs `RoutingContext` access.
For proactive authentication details, see Quarkus's guide.
====

include::{generated-dir}/config/quarkus-security-jpa.adoc[opts=optional, leveloffset=+2]

== References

* xref:security-getting-started-tutorial.adoc[Getting Started with Basic authentication and Jakarta Persistence]
* xref:security-identity-providers.adoc[Identity Providers]
* xref:security-overview.adoc[Quarkus Security Overview]
